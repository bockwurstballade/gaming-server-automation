- name: Ensure COD2 Dedicated Server is installed
  become: true
  become_user: root
  block:
    - name: Ensure COD2 related services are stopped
      ansible.builtin.include_role:
        name: roles/utils/os/systemd/service/stopped
      vars:
        utils_os_systemd_service_stopped__service_name: "{{ item }}"
      loop: "{{ games_cod2_server_installed__service_stop_targets }}"
      loop_control:
        label: "{{ item }}"

    - name: Ensure required packages are installed
      ansible.builtin.include_role:
        name: roles/utils/os/packages/installed
      vars:
        utils_os_packages_installed__packages: "{{ games_cod2_server_installed__packages }}"

    - name: Ensure COD2 service user exists
      ansible.builtin.include_role:
        name: roles/utils/os/users/service/created
      vars:
        utils_os_users_service_created__user: "{{ games_cod2_server_installed__user_name }}"
        utils_os_users_service_created__group: "{{ games_cod2_server_installed__group_name }}"
        utils_os_users_service_created__password: "{{ games_cod2_server_installed__user_password }}"
        utils_os_users_service_created__service_user_home: "{{ games_cod2_server_installed__home_directory }}"

    - name: Ensure /games directory exists
      ansible.builtin.file:
        path: /games/
        state: directory
        mode: '0755'
        owner: "{{ games_cod2_server_installed__user_name }}"
        group: users

    - name: Ensure COD2 directories exist with correct ownership
      ansible.builtin.include_role:
        name: roles/utils/os/users/service/directory/permissions/granted
      vars:
        utils_os_users_service_directory_permissions_granted__user: "{{ games_cod2_server_installed__user_name }}"
        utils_os_users_service_directory_permissions_granted__group: "{{ games_cod2_server_installed__group_name }}"
        utils_os_users_service_directory_permissions_granted__directories:
          - "{{ games_cod2_server_installed__directory }}"
          - "{{ games_cod2_server_installed__home_directory }}"
          - "{{ (games_cod2_server_installed__directory, 'main') | ansible.builtin.path_join }}"

    - name: Ensure COD2 archives are downloaded and extracted
      ansible.builtin.include_role:
        name: roles/utils/os/file/archive/download_and_extract
      vars:
        utils_os_file_archive_download_and_extract__src: "{{ item.src }}"
        utils_os_file_archive_download_and_extract__file_name: "{{ item.file_name }}"
        utils_os_file_archive_download_and_extract__dest: "{{ item.dest }}"
        utils_os_file_archive_download_and_extract__user: "{{ item.user | default(games_cod2_server_installed__user_name) }}"
        utils_os_file_archive_download_and_extract__group: "{{ item.group | default(games_cod2_server_installed__group_name) }}"
        utils_os_file_archive_download_and_extract__mode: "{{ item.mode | default('0775') }}"
        roles_utils_os_file_archive_download_and_extract__temp_mode: "{{ games_cod2_server_installed__temp_mode | default(true) }}"
      loop: "{{ games_cod2_server_installed__archives }}"
      loop_control:
        label: "{{ item.file_name }}"

    - name: Ensure LD_LIBRARY_PATH is set in .bashrc for cod2
      ansible.builtin.lineinfile:
        path: "{{ (games_cod2_server_installed__home_directory, '.bashrc') | ansible.builtin.path_join }}"
        regexp: '^export LD_LIBRARY_PATH=.*$'
        line: 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/lib:{{ games_cod2_server_installed__directory }}"'
        state: present
        owner: "{{ games_cod2_server_installed__user_name }}"
        group: "{{ games_cod2_server_installed__group_name }}"

    - name: Ensure autoexec_mp.cfg exists with correct content
      ansible.builtin.include_role:
        name: roles/utils/os/file/template/enforced
      vars:
        utils_os_file_template_enforced__directory: "{{ (games_cod2_server_installed__directory, 'main') | ansible.builtin.path_join }}"
        utils_os_file_template_enforced__file_name: autoexec_mp.cfg
        utils_os_file_template_enforced__user: "{{ games_cod2_server_installed__user_name }}"
        utils_os_file_template_enforced__group: "{{ games_cod2_server_installed__group_name }}"

    - name: Ensure server.cfg exists with correct content
      ansible.builtin.include_role:
        name: roles/utils/os/file/template/enforced
      vars:
        utils_os_file_template_enforced__directory: "{{ (games_cod2_server_installed__directory, 'main') | ansible.builtin.path_join }}"
        utils_os_file_template_enforced__file_name: "{{ games_cod2_server_installed__server_cfg }}"
        utils_os_file_template_enforced__user: "{{ games_cod2_server_installed__user_name }}"
        utils_os_file_template_enforced__group: "{{ games_cod2_server_installed__group_name }}"

    - name: Configure COD2 systemd service
      ansible.builtin.include_role:
        name: roles/utils/os/systemd/service/configured
      vars:
        utils_os_systemd_service_configured__service_name: "{{ games_cod2_server_installed__service_name }}"
        utils_os_systemd_service_configured__service_description: "{{ games_cod2_server_installed__service_description }}"
        utils_os_systemd_service_configured__user: "{{ games_cod2_server_installed__user_name }}"
        utils_os_systemd_service_configured__group: "{{ games_cod2_server_installed__group_name }}"
        utils_os_systemd_service_configured__working_directory: "{{ games_cod2_server_installed__directory }}"
        utils_os_systemd_service_configured__ld_library_path_string: "{{ games_cod2_server_installed__ld_library_path | join(':') }}{{ games_cod2_server_installed__systemd_environment_extra }}"
        utils_os_systemd_service_configured__execstart: "{{ games_cod2_server_installed__execstart }}"
