- name: Ensure required packages are installed
  ansible.builtin.include_role:
    name: roles/utils/os/packages/installed
  vars:
    utils_os_packages_installed__packages: "{{ games_quake_live_server_installed_packages }}"

- name: Install steamcmd
  ansible.builtin.include_role:
    name: roles/utils/os/packages/steamcmd/installed

- name: Ensure Existence of Service User
  ansible.builtin.include_role:
    name: roles/utils/os/users/service/created
  vars:
    - utils_os_users_service_created__group: "{{ games_quake_live_server_installed__group }}"
    - utils_os_users_service_created__user: "{{ games_quake_live_server_installed__user }}"

- name: Ensure /games/ directory exists
  become: true
  become_user: root
  ansible.builtin.file:
    path:  "/games/"
    state: directory
    mode: '0755'
    owner: "{{ games_quake_live_server_installed__user_name }}"
    group: users

- name: Ensure permissions on target directories
  ansible.builtin.include_role:
    name: roles/utils/os/users/service/directory/permissions/granted
  vars:
    utils_os_users_service_directory_permissions_granted__user: "{{ games_quake_live_server_installed__user }}"
    utils_os_users_service_directory_permissions_granted__group: "{{ games_quake_live_server_installed__group }}"
    utils_os_users_service_directory_permissions_granted__directories: "{{ games_quake_live_server_installed__service_directories }}"

- name: Install Quake Live Dedicated Server
  ansible.builtin.include_role:
    name: roles/utils/os/packages/steamcmd/app/installed
  vars:
    - utils_os_packages_steamcmd_app_installed__dest: "{{ games_quake_live_server_installed__directory }}"

- name: Ensure Environment Variables are properly set
  ansible.builtin.include_role:
    name: roles/utils/os/users/service/environment/variables/persisted
  vars:
    - utils_os_users_service_environment_variables_persisted__user: "{{ games_quake_live_server_installed__user }}"
    - utils_os_users_service_environment_variables_persisted__group: "{{ games_quake_live_server_installed__group }}"
    - utils_os_users_service_environment_variables_persisted__service_dir: "{{ games_quake_live_server_installed__directory }}"
    - utils_os_users_service_environment_variables_persisted__service_lib_subdir: "{{ games_quake_live_server_installed__lib_subdir }}"

- name: Ensure Symbolic Links
  ansible.builtin.include_role:
    name: roles/utils/os/file/links/symbolic/enforced
  vars:
    utils_os_file_links_symbolic_enforced__user: "{{ games_half_life_2_server_installed__user }}"
    utils_os_file_links_symbolic_enforced__group: "{{ games_half_life_2_server_installed__group }}"
    utils_os_file_links_symbolic_enforced__links: "{{ games_half_life_2_server_installed__symlinks }}"

- name: Enforce server.cfg template
  ansible.builtin.include_role:
    name: roles/utils/os/file/template/enforced
  vars:
    utils_os_file_template_enforced__directory: "{{ games_quake_live_server_installed__baseq3 }}"
    utils_os_file_template_enforced__file_name: "server.cfg"
    utils_os_file_template_enforced__user: "{{ games_quake_live_server_installed__user }}"
    utils_os_file_template_enforced__group: "{{ games_quake_live_server_installed__group }}"

- name: Enforce access.txst template
  ansible.builtin.include_role:
    name: roles/utils/os/file/template/enforced
  vars:
    utils_os_file_template_enforced__directory: "{{ games_quake_live_server_installed__baseq3 }}"
    utils_os_file_template_enforced__file_name: "access.txt"
    utils_os_file_template_enforced__user: "{{ games_quake_live_server_installed__user }}"
    utils_os_file_template_enforced__group: "{{ games_quake_live_server_installed__group }}"

- name: Install Quake Live Server
  become: true
  become_user: root
  block:

    # Install QL Server
    - name: "Create systemd service file for quake live"
      ansible.builtin.copy:
        dest: "/etc/systemd/system/{{ games_quake_live_server_installed__service_name }}.service"
        content: |
          [Unit]
          Description={{ games_quake_live_server_installed__service_description }}
          After=network.target

          [Service]
          User={{ games_quake_live_server_installed__user_name }}
          Group={{ games_quake_live_server_installed__group_name }}
          WorkingDirectory={{ games_quake_live_server_installed__directory }}
          Environment="LD_LIBRARY_PATH=/lib:/lib64:{{ games_quake_live_server_installed__directory }}linux64"
          ExecStart={{ games_quake_live_server_installed__directory }}qzeroded.x64 +set fs_basepath {{ games_quake_live_server_installed__directory }} +set fs_homepath {{ games_quake_live_server_installed__service_user_home }}/.quakelive +set ttycon 0
          Restart=on-failure
          Type=simple
          KillMode=process

          [Install]
          WantedBy=multi-user.target
        owner: root
        group: root
        mode: '0644'